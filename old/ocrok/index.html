<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OCR Camera Tool</title>

<style>
    body {
        margin: 0;
        background: #111;
        font-family: system-ui;
        color: white;
        text-align: center;
    }

    .page { display: none; }
    .active { display: block; }

    button {
        padding: 15px 22px;
        margin: 10px;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        background: #00b3ff;
        color: #fff;
    }

    /* ---------- CONSTRAINED CAMERA BOX ---------- */
    #camBox {
        position: relative;
        width: 100vw;
        max-width: 600px;
        margin: 20px auto;
        background: black;
        overflow: hidden;
    }

    #video, #overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        touch-action: none;
    }

    #resultText {
        font-size: 20px;
        margin-top: 20px;
        color: #0ff;
        white-space: pre-wrap;
    }

    #capPreview {
        max-width: 90%;
        margin-top: 15px;
        border: 2px solid #444;
    }
</style>
</head>
<body>

<!-- ====================== PAGE 1 ====================== -->
<div id="page1" class="page active">
    <h2>OCR Camera Tool</h2>

    <button id="btnStart">Start Camera</button>

    <div id="resultText">(Result will appear here)</div>

    <img id="capPreview" />
</div>

<!-- ====================== PAGE 2 ====================== -->
<div id="page2" class="page">
    <button id="btnClose">Close</button>

    <div id="camBox">
        <video id="video" autoplay playsinline></video>
        <canvas id="overlay"></canvas>
    </div>

    <p>Draw a rectangle to capture</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
// ========== PAGE CONTROL ==========
function goPage1() {
    page1.classList.add("active");
    page2.classList.remove("active");
}
function goPage2() {
    page2.classList.add("active");
    page1.classList.remove("active");
}

const page1 = document.getElementById("page1");
const page2 = document.getElementById("page2");

document.getElementById("btnStart").onclick = startCamera;
document.getElementById("btnClose").onclick = stopCamera;


// ========== CAMERA ==========
let stream;
const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const ctx = overlay.getContext("2d");
const camBox = document.getElementById("camBox");

async function startCamera() {
    goPage2();

    stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
    });

    video.srcObject = stream;

    video.onloadedmetadata = () => {
        const W = video.videoWidth;
        const H = video.videoHeight;

        const ratio = W / H;

        // Constrain camera box – maintain exact aspect ratio
        camBox.style.width = "100vw";
        camBox.style.maxWidth = "600px";
        camBox.style.height = (camBox.clientWidth / ratio) + "px";

        // Set canvas 1:1 with video feed resolution
        overlay.width = W;
        overlay.height = H;
    };
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
    }
    ctx.clearRect(0,0,overlay.width,overlay.height);
    goPage1();
}


// ========== DRAWING ==========
let drawing = false;
let startX, startY, endX, endY;

function getPos(e) {
    const rect = overlay.getBoundingClientRect();

    let clientX = e.touches ? e.touches[0].clientX : e.clientX;
    let clientY = e.touches ? e.touches[0].clientY : e.clientY;

    // CSS px → video px mapping
    const scaleX = overlay.width / rect.width;
    const scaleY = overlay.height / rect.height;

    return {
        x: (clientX - rect.left) * scaleX,
        y: (clientY - rect.top) * scaleY
    };
}

function redrawMask() {
    ctx.clearRect(0,0,overlay.width,overlay.height);

    ctx.fillStyle = "rgba(0,0,0,0.65)";
    ctx.fillRect(0,0,overlay.width,overlay.height);

    const w = endX - startX;
    const h = endY - startY;

    ctx.clearRect(startX, startY, w, h);
    ctx.strokeStyle = "yellow";
    ctx.lineWidth = 3;
    ctx.strokeRect(startX, startY, w, h);
}

function startDraw(e) {
    drawing = true;
    const p = getPos(e);
    startX = endX = p.x;
    startY = endY = p.y;
    redrawMask();
}

function moveDraw(e) {
    if (!drawing) return;
    e.preventDefault();
    const p = getPos(e);
    endX = p.x;
    endY = p.y;
    redrawMask();
}

function endDraw() {
    if (!drawing) return;
    drawing = false;
    redrawMask();
    snapshotAndOCR();
}

overlay.addEventListener("mousedown", startDraw);
overlay.addEventListener("mousemove", moveDraw);
overlay.addEventListener("mouseup", endDraw);

overlay.addEventListener("touchstart", startDraw);
overlay.addEventListener("touchmove", moveDraw);
overlay.addEventListener("touchend", endDraw);


// ========== SNAPSHOT + OCR ==========
async function snapshotAndOCR() {
    const x1 = startX, y1 = startY;
    const x2 = endX, y2 = endY;

    const sx = Math.min(x1, x2);
    const sy = Math.min(y1, y2);
    const sw = Math.abs(x2 - x1);
    const sh = Math.abs(y2 - y1);

    if (sw < 10 || sh < 10) return;

    const snap = document.createElement("canvas");
    snap.width = sw;
    snap.height = sh;

    const sctx = snap.getContext("2d");
    sctx.drawImage(video, sx, sy, sw, sh, 0, 0, sw, sh);

    // Show captured image on Page 1
    document.getElementById("capPreview").src = snap.toDataURL("image/png");

    stopCamera();

    document.getElementById("resultText").textContent = "OCR running...";

    const res = await Tesseract.recognize(snap, "eng", {
        tessedit_char_whitelist: "0123456789",
    });

    let txt = res.data.text.trim();
    if (!txt) txt = "(No text found)";

    document.getElementById("resultText").textContent = txt;
}
</script>

</body>
</html>
