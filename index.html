<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OCR Crop Tool</title>

<style>
    body {
        margin: 0;
        background: #111;
        font-family: system-ui;
        color: white;
        text-align: center;
    }

    .page { display: none; }
    .active { display: block; }

    button {
        padding: 15px 22px;
        margin: 10px;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        background: #00c3ff;
        color: #fff;
    }

    #video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: fixed;
        top: 0; left: 0;
    }

    #overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        touch-action: none;
    }

    .toolbar {
        position: fixed;
        top: 10px;
        width: 100%;
        text-align: center;
        z-index: 20;
    }

    #resultText {
        margin-top: 30px;
        font-size: 20px;
        padding: 20px;
        color: #0ff;
        white-space: pre-wrap;
    }
</style>
</head>
<body>

<!-- ====================== PAGE 1 ====================== -->
<div id="page1" class="page active">
    <h2>OCR Camera Tool</h2>
    <button id="btnStart">Start Camera</button>
    <div id="resultText">(Result will appear here)</div>
</div>

<!-- ====================== PAGE 2 (Camera) ====================== -->
<div id="page2" class="page">
    <div class="toolbar">
        <button id="btnClose">Close</button>
    </div>

    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
// ========== PAGE CONTROL ==========
const page1 = document.getElementById("page1");
const page2 = document.getElementById("page2");

function goPage1() {
    page1.classList.add("active");
    page2.classList.remove("active");
}
function goPage2() {
    page2.classList.add("active");
    page1.classList.remove("active");
}

document.getElementById("btnStart").onclick = startCamera;
document.getElementById("btnClose").onclick = stopCamera;


// ========== CAMERA ==========
let stream;
const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const ctx = overlay.getContext("2d");

async function startCamera() {
    goPage2();

    stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
    });

    video.srcObject = stream;

    video.onloadedmetadata = () => {
        overlay.width = video.videoWidth;
        overlay.height = video.videoHeight;
    };
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
    }
    ctx.clearRect(0,0,overlay.width,overlay.height);
    goPage1();
}


// ========== DRAWING ==========
let drawing = false;
let startX, startY, endX, endY;

function getPos(e) {
    const rect = overlay.getBoundingClientRect();

    let clientX, clientY;

    if (e.touches) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
    } else {
        clientX = e.clientX;
        clientY = e.clientY;
    }

    // Convert CSS pixels â†’ video pixels
    const scaleX = video.videoWidth / rect.width;
    const scaleY = video.videoHeight / rect.height;

    return {
        x: (clientX - rect.left) * scaleX,
        y: (clientY - rect.top) * scaleY
    };
}

function redrawMask() {
    ctx.clearRect(0,0,overlay.width,overlay.height);

    ctx.fillStyle = "rgba(0,0,0,0.65)";
    ctx.fillRect(0,0,overlay.width,overlay.height);

    const w = endX - startX;
    const h = endY - startY;

    ctx.clearRect(startX, startY, w, h);
    ctx.strokeStyle = "yellow";
    ctx.lineWidth = 3;
    ctx.strokeRect(startX, startY, w, h);
}

function startDraw(e) {
    drawing = true;
    const p = getPos(e);
    startX = endX = p.x;
    startY = endY = p.y;
    redrawMask();
}

function moveDraw(e) {
    if (!drawing) return;
    e.preventDefault();
    const p = getPos(e);
    endX = p.x;
    endY = p.y;
    redrawMask();
}

function endDraw() {
    if (!drawing) return;
    drawing = false;
    redrawMask();
    snapshotAndOCR();
}

overlay.addEventListener("mousedown", startDraw);
overlay.addEventListener("mousemove", moveDraw);
overlay.addEventListener("mouseup", endDraw);

overlay.addEventListener("touchstart", startDraw);
overlay.addEventListener("touchmove", moveDraw);
overlay.addEventListener("touchend", endDraw);


// ========== SNAPSHOT + OCR ==========
async function snapshotAndOCR() {
    // Normalize rectangle so it works no matter how you drag
    const x1 = startX;
    const y1 = startY;
    const x2 = endX;
    const y2 = endY;

    const sx = Math.min(x1, x2);
    const sy = Math.min(y1, y2);
    const sw = Math.abs(x2 - x1);
    const sh = Math.abs(y2 - y1);

    if (sw < 10 || sh < 10) return; // ignore tiny boxes

    // Make the snapshot a bit bigger for better OCR
    const scale = 2;
    const snap = document.createElement("canvas");
    snap.width = sw * scale;
    snap.height = sh * scale;
    const sctx = snap.getContext("2d");

    sctx.imageSmoothingEnabled = false;
    sctx.drawImage(
        video,
        sx, sy, sw, sh,       // source in video
        0, 0, snap.width, snap.height // scaled destination
    );

    // Stop camera & go back to first page
    stopCamera();

    const resultLabel = document.getElementById("resultText");
    resultLabel.textContent = "OCR running...";

    // Focus OCR on digits (you can expand this whitelist later)
    const res = await Tesseract.recognize(snap, "eng", {
        tessedit_char_whitelist: "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-",
        logger: m => console.log(m) // optional, for debug
    });

    let txt = (res.data.text || "").trim();
    if (!txt) txt = "(No text found)";

    resultLabel.textContent = txt;
}

</script>

</body>
</html>
