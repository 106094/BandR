<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Barcode + OCR Scanner</title>
  <style>
    body { margin:0; font-family:system-ui,-apple-system,sans-serif; background:#111; color:#fff; }
    .container { padding:30px; text-align:center; min-height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    button { padding:18px 40px; font-size:20px; background:#0f0; color:#000; border:none; border-radius:16px; font-weight:bold; }
    input { margin-top:20px; padding:14px; width:90%; max-width:500px; font-size:18px; text-align:center; font-family:monospace; }

    /* Full-screen modal */
    #scannerModal {
      display: none;
      position: fixed; inset:0; background:rgba(0,0,0,0.98); z-index:9999;
      flex-direction:column; justify-content:center; align-items:center;
    }
    #video { width:95vw; max-width:560px; height:auto; border:5px solid #0f0; border-radius:16px; background:#000; }
    #closeBtn { margin-top:20px; padding:12px 30px; background:#333; border:2px solid #0f0; color:#0f0; font-size:18px; border-radius:12px; }
    #status { margin:15px 0; font-size:18px; color:#0f9; }
  </style>
</head>
<body>

  <!-- HTTPS guard -->
  <script>
    if (location.protocol !== 'https:' && !['localhost','127.0.0.1','0.0.0.0'].includes(location.hostname)) {
      document.body.innerHTML = `<div style="padding:40px;text-align:center;color:#fff;background:#300;"><h2>HTTPS Required</h2><p>Camera only works on secure pages.<br>Use GitHub Pages!</p></div>`;
      throw "No HTTPS";
    }
  </script>

  <div class="container">
    <h1>Barcode Scanner<br><small style="font-size:0.5em;color:#aaa">with OCR fallback</small></h1>
    <button onclick="openScanner()">Start Scanning</button>
    <input id="result" placeholder="Result will appear here" readonly>
  </div>

  <!-- Full-screen camera modal -->
  <div id="scannerModal">
    <video id="video" playsinline muted></video>
    <div id="status">Initializing camera...</div>
    <button id="closeBtn" onclick="closeScanner()">Close</button>
  </div>

  <script type="module">
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/+esm';

    const modal   = document.getElementById('scannerModal');
    const video   = document.getElementById('video');
    const status  = document.getElementById('status');
    const result  = document.getElementById('result');
    let codeReader = null;
    let stream = null;

    window.openScanner = async () => {
      result.value = '';
      modal.style.display = 'flex';
      status.textContent = 'Requesting camera...';

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }
        });

        video.srcObject = stream;
        await video.play();
        status.textContent = 'Scanning barcode...';

        codeReader = new BrowserMultiFormatReader();
        codeReader.decodeFromVideoElement(video, (res, err) => {
          if (res) {
            handleResult(res.getText());
          }
        });

        // OCR fallback after 9 seconds
        setTimeout(() => {
          if (!result.value) {
            status.textContent = 'No barcode → Running OCR...';
            runOCR();
          }
        }, 9000);

      } catch (e) {
        status.innerHTML = `<span style="color:#f66">Camera error: ${e.message}</span>`;
      }
    };

    async function runOCR() {
      if (!video.videoWidth) return;
      const canvas = document.createElement('canvas');
      canvas.width  = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);

      // Lazy-load Tesseract only when needed
      const { createWorker } = Tesseract;
      const worker = await createWorker({
        logger: m => {
          if (m.status === 'recognizing text') status.textContent = `OCR ${(m.progress*100).toFixed(0)}%`;
        }
      });

      await worker.load();
      await worker.loadLanguage('eng');
      await worker.initialize('eng');
      await worker.setParameters({
        tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-',
        tessedit_pageseg_mode: '7',  // single line — perfect for codes
      });

      const { data: { text } } = await worker.recognize(canvas);
      await worker.terminate();

      const clean = text.trim().replace(/\s+/g, '');
      if (clean.length >= 6 && /^[0-9A-Za-z-]+$/.test(clean)) {
        handleResult(clean);
      } else {
        status.textContent = 'Nothing readable — try again';
      }
    }

    function handleResult(text) {
      result.value = text;
      status.textContent = 'Success!';
      setTimeout(closeScanner, 1200);
    }

    window.closeScanner = () => {
      if (codeReader) { codeReader.reset(); codeReader = null; }
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      video.srcObject = null;
      modal.style.display = 'none';
    };

    // Lazy load Tesseract only when OCR is actually needed
    const tesseractScript = document.createElement('script');
    tesseractScript.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
    document.head.appendChild(tesseractScript);
  </script>
</body>
</html>
