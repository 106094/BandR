<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Barcode + OCR Scanner</title>
  <style>
    #scannerModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; flex-direction: column; z-index: 9999; }
    #video { width: 90vw; max-width: 500px; height: auto; border: 3px solid #0f0; border-radius: 12px; }
    #ocrCanvas { display: none; }
    .close-btn { margin-top: 20px; padding: 10px 20px; font-size: 18px; }
  </style>
</head>
<body>

<button onclick="openScanner('result')">Scan Barcode / Text</button>
<input id="result" placeholder="Result will appear here" readonly>

<div id="scannerModal">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="ocrCanvas"></canvas>
  <button class="close-btn" onclick="closeScanner()">Close</button>
  <div style="color:white; margin-top:10px;" id="status">Scanning barcode...</div>
</div>

<!-- ZXing + Tesseract via CDN -->
<script type="module">
  import {
    BrowserMultiFormatReader,
    DecodeHintType,
    BarcodeFormat
  } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/+esm";

  // Tesseract.js worker from CDN
  import { createWorker } from 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js';

  const hints = new Map();
  hints.set(DecodeHintType.POSSIBLE_FORMATS, [
    BarcodeFormat.QR_CODE,
    BarcodeFormat.CODE_128,
    BarcodeFormat.CODE_39,
    BarcodeFormat.EAN_13,
    BarcodeFormat.EAN_8,
    BarcodeFormat.UPC_A,
    BarcodeFormat.DATA_MATRIX,
    BarcodeFormat.ITF
  ]);
  hints.set(DecodeHintType.TRY_HARDER, true);

  window.ZXingBrowser = { BrowserMultiFormatReader, DecodeHintType, BarcodeFormat, hints };

  let codeReader = null;
  let currentInputEl = null;
  let ocrTimeout = null;
  let ocrRunning = false;

  window.openScanner = async function(targetId = null, directInputEl = null) {
    if (!window.ZXingBrowser) return alert("ZXing not loaded");

    const { BrowserMultiFormatReader, hints } = window.ZXingBrowser;
    codeReader = new BrowserMultiFormatReader(hints);
    currentInputEl = directInputEl || (targetId ? document.getElementById(targetId) : null);

    document.getElementById('scannerModal').style.display = 'flex';
    document.getElementById('status').textContent = 'Scanning barcode...';

    const video = document.getElementById('video');
    const canvas = document.getElementById('ocrCanvas');
    const ctx = canvas.getContext('2d');

    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }
      });
      video.srcObject = stream;
      await video.play();

      // Start ZXing continuous decoding
      codeReader.decodeFromVideoElement(video, (result, error) => {
        if (result) {
          handleSuccess(result.getText());
        }
        // If no result for 8 seconds → trigger OCR
        if (!ocrRunning) {
          clearTimeout(ocrTimeout);
          ocrTimeout = setTimeout(() => startOCR(video, canvas, ctx), 8000);
        }
      });

    } catch (err) {
      toast(`Camera error: ${err.message}`);
      closeScanner();
    }
  };

  async function startOCR(video, canvas, ctx) {
    if (ocrRunning) return;
    ocrRunning = true;
    document.getElementById('status').textContent = 'Barcode not found → Running OCR...';

    // Capture current frame
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const worker = await createWorker({
      logger: m => {
        if (m.status === 'recognizing text') {
          document.getElementById('status').textContent = `OCR: ${(m.progress * 100).toFixed(0)}%`;
        }
      }
    });

    await worker.load();
    await worker.loadLanguage('eng');
    await worker.initialize('eng');
    
    // Optimize for digits + some letters
    await worker.setParameters({
      tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-',
      tessedit_pageseg_mode: '7', // treat as single text line (good for barcodes/text below)
    });

    const { data: { text } } = await worker.recognize(canvas);
    await worker.terminate();

    const cleaned = text.trim().replace(/\s+/g, '');
    
    // Heuristic: if result is mostly digits and reasonable length, accept it
    if (cleaned.length >= 6 && /^[0-9A-Za-z-]{6,}$/.test(cleaned)) {
      handleSuccess(cleaned);
    } else {
      document.getElementById('status').textContent = 'Nothing readable found';
      setTimeout(() => {
        if (document.getElementById('scannerModal').style.display === 'flex') {
          document.getElementById('status').textContent = 'Keep trying...';
          ocrRunning = false;
          ocrTimeout = setTimeout(() => startOCR(video, canvas, ctx), 5000);
        }
      }, 3000);
    }
  }

  function handleSuccess(text) {
    clearTimeout(ocrTimeout);
    if (codeReader) codeReader.reset();

    if (currentInputEl) {
      currentInputEl.value = text;
      currentInputEl.dispatchEvent(new Event('input', { bubbles: true }));
    }

    toast(`Success: ${text}`);
    closeScanner();
  }

  window.closeScanner = function() {
    if (codeReader) {
      codeReader.reset();
      codeReader = null;
    }
    clearTimeout(ocrTimeout);
    ocrRunning = false;

    const video = document.getElementById('video');
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(t => t.stop());
      video.srcObject = null;
    }
    document.getElementById('scannerModal').style.display = 'none';
  };

  function toast(msg) {
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:12px 24px; border-radius:8px; z-index:10000;';
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3000);
  }
</script>
</body>
</html>
