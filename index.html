<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Barcode + OCR Scanner</title>
  <style>
    body { margin:0; font-family:system-ui,-apple-system,sans-serif; background:#111; color:#fff; text-align:center; padding:30px 20px; }
    h1 { margin-bottom:30px; }
    button { padding:16px 36px; font-size:19px; background:#0f0; color:#000; border:none; border-radius:14px; font-weight:bold; }
    input { margin-top:20px; padding:14px; width:90%; max-width:460px; font-size:18px; text-align:center; font-family:monospace; border-radius:10px; border:none; }

    /* Scanner Modal */
    #scannerModal {
      display:none; position:fixed; inset:0; background:#000; z-index:9999;
      flex-direction:column; justify-content:center; align-items:center; padding:20px; box-sizing:border-box;
    }
    .scanner-box {
      position:relative; width:90vw; max-width:460px; aspect-ratio:1.4;
      border:4px solid #0f0; border-radius:18px; overflow:hidden; background:#000;
      box-shadow:0 0 30px rgba(0,255,0,0.4);
    }
    #video { width:100%; height:100%; object-fit:cover; }
    .corner {
      position:absolute; width:40px; height:40px; border:6px solid #0f0;
    }
    .corner:nth-child(1){ top:15px; left:15px; border-right:none; border-bottom:none; }
    .corner:nth-child(2){ top:15px; right:15px; border-left:none; border-bottom:none; }
    .corner:nth-child(3){ bottom:15px; left:15px; border-right:none; border-top:none; }
    .corner:nth-child(4){ bottom:15px; right:15px; border-left:none; border-top:none; }

    #status { margin:20px 0; font-size:18px; color:#0f9; min-height:24px; }
    #closeBtn { padding:12px 32px; background:#333; border:2px solid #0f0; color:#0f0; font-size:17px; border-radius:12px; }
  </style>
</head>
<body>

  <!-- HTTPS guard -->
  <script>
    if (location.protocol !== 'https:' && !['localhost','127.0.0.1','0.0.0.0'].includes(location.hostname)) {
      document.body.innerHTML = `<div style="padding:50px;color:#fff;background:#300;"><h2>HTTPS Required</h2><p>Use GitHub Pages to open this page.</p></div>`;
      throw "No HTTPS";
    }
  </script>

  <h1>Barcode Scanner<br><small style="font-size:0.5em;color:#888">with OCR fallback</small></h1>
  <button onclick="openScanner()">Start Scanning</button>
  <input id="result" placeholder="Result will appear here" readonly>

  <!-- Scanner Modal -->
  <div id="scannerModal">
    <div class="scanner-box">
      <video id="video" playsinline muted></video>
      <div class="corner"></div><div class="corner"></div><div class="corner"></div><div class="corner"></div>
    </div>
    <div id="status">Initializing camera...</div>
    <button id="closeBtn" onclick="closeScanner()">Close</button>
  </div>

  <script type="module">
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/+esm';

    const modal   = document.getElementById('scannerModal');
    const video   = document.getElementById('video');
    const status  = document.getElementById('status');
    const result  = document.getElementById('result');
    let codeReader = null;
    let stream = null;
    let ocrAttempted = false;

    window.openScanner = async () => {
      result.value = '';
      ocrAttempted = false;
      modal.style.display = 'flex';
      status.textContent = 'Opening camera...';

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }
        });
        video.srcObject = stream;
        await video.play();
        status.textContent = 'Scan barcode';

        codeReader = new BrowserMultiFormatReader();
        codeReader.decodeFromVideoElement(video, (res, err) => {
          if (res) {
            success(res.getText());
          }
        });

        // Try OCR only once after 9 seconds
        setTimeout(() => {
          if (!result.value && !ocrAttempted) {
            ocrAttempted = true;
            status.textContent = 'No barcode → trying OCR...';
            runOCR();
          }
        }, 9000);

      } catch (e) {
        status.innerHTML = `<span style="color:#f66">Camera error: ${e.message}</span>`;
      }
    };

    async function runOCR() {
      if (!video.videoWidth) return;
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);

      const { createWorker } = Tesseract;
      const worker = await createWorker({
        logger: m => {
          if (m.status === 'recognizing text') {
            status.textContent = `OCR ${Math.round(m.progress*100)}%`;
          }
        }
      });

      await worker.load();
      await worker.loadLanguage('eng');
      await worker.initialize('eng');
      await worker.setParameters({
        tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-',
        tessedit_pageseg_mode: '7'
      });

      const { data: { text } } = await worker.recognize(canvas);
      await worker.terminate();

      const clean = text.trim().replace(/\s+/g, '');
      if (clean.length >= 6 && /^[0-9A-Za-z-]+$/.test(clean)) {
        success(clean);
      } else {
        status.textContent = 'Nothing found — try moving closer or better lighting';
      }
    }

    function success(text) {
      result.value = text;
      status.textContent = 'Success! Closing...';
      setTimeout(closeScanner, 1200);
    }

    window.closeScanner = () => {
      if (codeReader) { codeReader.reset(); codeReader = null; }
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      video.srcObject = null;
      modal.style.display = 'none';
    };

    // Lazy-load Tesseract only when needed
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
    document.head.appendChild(script);
  </script>
</body>
</html>
