
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>QR / Barcode + OCR Scanner</title>
  <style>
    body { margin:0; font-family:system-ui,-apple-system,sans-serif; background:#111; color:#fff; text-align:center; padding:30px 20px; }
    h1 { margin-bottom:30px; }
    button { padding:18px 40px; font-size:20px; background:#0f9; color:#000; border:none; border-radius:16px; font-weight:bold; }
    input { margin-top:20px; padding:14px; width:90%; max-width:460px; font-size:18px; text-align:center; font-family:monospace; border-radius:10px; border:none; }

    #scannerModal {
      display:none; position:fixed; inset:0; background:#000; z-index:9999;
      flex-direction:column; justify-content:center; align-items:center;
    }
    .scanner-box {
      position:relative; width:90vw; max-width:460px; height:360px;
      border:5px solid #0f9; border-radius:20px; overflow:hidden; background:#000;
      box-shadow:0 0 50px rgba(0,255,150,0.6);
    }
    #video { width:100%; height:100%; object-fit:cover; background:#000; }
    .corner { position:absolute; width:60px; height:60px; border:7px solid #0f9; pointer-events:none; }
    .corner:nth-child(1){ top:20px; left:20px; border-right:none; border-bottom:none; }
    .corner:nth-child(2){ top:20px; right:20px; border-left:none; border-bottom:none; }
    .corner:nth-child(3){ bottom:20px; left:20px; border-right:none; border-top:none; }
    .corner:nth-child(4){ bottom:20px; right:20px; border-left:none; border-top:none; }

    #status { margin:20px 0; font-size:19px; color:#0ff; min-height:30px; }
    #closeBtn { padding:14px 36px; background:#333; border:3px solid #0f9; color:#0f9; font-size:18px; border-radius:14px; }
  </style>
</head>
<body>

  <!-- HTTPS Guard -->
  <script>
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      document.body.innerHTML = '<div style="padding:60px;color:#fff;background:#300;"><h2>HTTPS Required</h2><p>Use GitHub Pages!</p></div>';
      throw "No HTTPS";
    }
  </script>

  <h1>QR / Barcode + OCR Scanner</h1>
  <button onclick="openScanner()">Start Camera</button>
  <input id="result" placeholder="Result will appear here" readonly>

  <!-- Scanner Modal -->
  <div id="scannerModal">
    <div class="scanner-box">
      <video id="video" playsinline muted autoplay></video>
      <div class="corner"></div><div class="corner"></div><div class="corner"></div><div class="corner"></div>
    </div>
    <div id="status">Opening camera...</div>
    <button id="closeBtn" onclick="closeScanner()">Close</button>
  </div>

  <script type="module">
    import { BrowserMultiFormatReader, BarcodeFormat, DecodeHintType } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/+esm';

    const modal   = document.getElementById('scannerModal');
    const video   = document.getElementById('video');
    const status  = document.getElementById('status');
    const result  = document.getElementById('result');
    let codeReader = null;
    let stream = null;
    let ocrDone = false;

    const hints = new Map();
    hints.set(DecodeHintType.POSSIBLE_FORMATS, [BarcodeFormat.QR_CODE, BarcodeFormat.CODE_128, BarcodeFormat.CODE_39, BarcodeFormat.EAN_13, BarcodeFormat.EAN_8, BarcodeFormat.UPC_A, BarcodeFormat.ITF, BarcodeFormat.DATA_MATRIX]);
    hints.set(DecodeHintType.TRY_HARDER, true);

    window.openScanner = async () => {
      result.value = '';
      ocrDone = false;
      modal.style.display = 'flex';
      status.textContent = 'Requesting camera permission...';

      try {
        // Critical: force video visible BEFORE attaching stream
        video.style.opacity = '0';
        modal.style.display = 'flex';

        stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        });

        video.srcObject = stream;
        
        // Wait for video to actually start playing
        await new Promise(resolve => {
          video.onloadedmetadata = () => {
            video.play().then(() => {
              video.style.opacity = '1';
              status.textContent = 'Scan QR or barcode';
              resolve();
            });
          };
        });

        codeReader = new BrowserMultiFormatReader(hints);
        codeReader.decodeFromVideoElement(video, (res) => {
          if (res) success(res.getText());
        });

        // OCR fallback after 8 seconds
        setTimeout(() => {
          if (!result.value && !ocrDone) {
            ocrDone = true;
            status.textContent = 'No code found → OCR...';
            runOCR();
          }
        }, 8000);

      } catch (err) {
        status.innerHTML = `<span style="color:#f66">Camera failed: ${err.message}</span>`;
        console.error(err);
      }
    };

    async function runOCR() {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth || 1280;
      canvas.height = video.videoHeight || 720;
      canvas.getContext('2d').drawImage(video, 0, 0);

      // Load Tesseract only when needed
      if (!window.Tesseract) {
        await new Promise(r => {
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
          s.onload = r;
          document.head.appendChild(s);
        });
      }

      const worker = await Tesseract.createWorker();
      await worker.load();
      await worker.loadLanguage('eng');
      await worker.initialize('eng');
      await worker.setParameters({
        tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-',
        tessedit_pageseg_mode: '7'
      });

      const { data: { text } } = await worker.recognize(canvas);
      await worker.terminate();

      const clean = text.trim().replace(/[^A-Z0-9-]/gi, '');
      if (clean.length >= 6) success(clean);
      else status.textContent = 'Nothing readable — try again';
    }

    function success(text) {
      result.value = text;
      status.textContent = 'Success!';
      setTimeout(closeScanner, 1400);
    }

    window.closeScanner = () => {
      if (codeReader) { codeReader.reset(); codeReader = null; }
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      video.srcObject = null;
      modal.style.display = 'none';
    };
  </script>
</body>
</html>
