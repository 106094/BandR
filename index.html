<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OCR Camera Crop Tool</title>

<style>
    body {
        margin: 0;
        background: #111;
        font-family: system-ui;
        color: white;
        user-select: none;
        overflow: hidden;
        touch-action: none;
    }

    #video {
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
    }

    #overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        touch-action: none;
    }

    .top-bar {
        position: fixed;
        top: 0;
        width: 100%;
        padding: 10px;
        text-align: center;
        background: rgba(0,0,0,0.4);
        backdrop-filter: blur(8px);
    }

    button {
        padding: 10px 16px;
        margin: 5px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        background: #00b3ff;
        color: #fff;
        cursor: pointer;
    }

    button:active {
        opacity: 0.7;
    }

    #ocrResult {
        position: fixed;
        bottom: 0;
        width: 100%;
        padding: 15px;
        background: rgba(0,0,0,0.7);
        font-size: 18px;
        text-align: center;
    }

</style>
</head>
<body>

<div class="top-bar">
    <button id="btnTorch">ðŸ”¦ Torch</button>
    <button id="btnClear">Clear</button>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="overlay"></canvas>

<div id="ocrResult">Draw a rectangle around textâ€¦</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const ctx = overlay.getContext("2d");
const ocrOutput = document.getElementById("ocrResult");

let stream;
let track;
let torchEnabled = false;

let drawing = false;
let startX = 0, startY = 0, endX = 0, endY = 0;

// ========== CAMERA SETUP ==========
async function startCamera() {
    stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
    });

    video.srcObject = stream;

    track = stream.getVideoTracks()[0];

    video.onloadedmetadata = () => {
        overlay.width = video.videoWidth;
        overlay.height = video.videoHeight;
    };
}

startCamera();

// ========== TORCH ==========
document.getElementById("btnTorch").addEventListener("click", () => {
    if (!track) return;

    torchEnabled = !torchEnabled;
    track.applyConstraints({
        advanced: [{ torch: torchEnabled }]
    }).catch(e => console.log("Torch error:", e));
});

// ========== CLEAR ==========
document.getElementById("btnClear").addEventListener("click", () => {
    ctx.clearRect(0,0,overlay.width,overlay.height);
    ocrOutput.textContent = "Draw a rectangle around textâ€¦";
});

// ========== POSITION HELPER ==========
function getPos(e) {
    const rect = overlay.getBoundingClientRect();
    if (e.touches) {
        return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top
        };
    }
    return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
    };
}

// ========== MASK DRAW ==========
function redrawMask() {
    ctx.clearRect(0, 0, overlay.width, overlay.height);

    // Darken outside
    ctx.fillStyle = "rgba(0,0,0,0.65)";
    ctx.fillRect(0, 0, overlay.width, overlay.height);

    const w = endX - startX;
    const h = endY - startY;

    // Clear inside box
    ctx.clearRect(startX, startY, w, h);

    // Border
    ctx.strokeStyle = "yellow";
    ctx.lineWidth = 3;
    ctx.strokeRect(startX, startY, w, h);
}

// ========== DRAW EVENTS ==========
function startDraw(e) {
    drawing = true;
    const p = getPos(e);
    startX = endX = p.x;
    startY = endY = p.y;
    redrawMask();
}

function moveDraw(e) {
    if (!drawing) return;
    e.preventDefault();
    const p = getPos(e);
    endX = p.x;
    endY = p.y;
    redrawMask();
}

function endDraw() {
    if (!drawing) return;
    drawing = false;
    redrawMask();
    captureAndOCR();
}

overlay.addEventListener("mousedown", startDraw);
overlay.addEventListener("mousemove", moveDraw);
overlay.addEventListener("mouseup", endDraw);

overlay.addEventListener("touchstart", startDraw);
overlay.addEventListener("touchmove", moveDraw);
overlay.addEventListener("touchend", endDraw);

// ========== CAPTURE & OCR ==========
async function captureAndOCR() {
    let w = endX - startX;
    let h = endY - startY;

    if (w < 10 || h < 10) return;

    let output = document.createElement("canvas");
    output.width = Math.abs(w);
    output.height = Math.abs(h);
    let octx = output.getContext("2d");

    octx.drawImage(video, startX, startY, w, h, 0, 0, output.width, output.height);

    ocrOutput.textContent = "Processing OCRâ€¦";

    // Tesseract OCR
    const res = await Tesseract.recognize(output, 'eng', {
        logger: () => {}
    });

    const text = res.data.text.trim();

    ocrOutput.textContent = text || "(No readable text)";
}
</script>

</body>
</html>
